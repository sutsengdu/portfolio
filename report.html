<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Company Expense Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Noto+Sans+Myanmar:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.7.0/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #1976d2;
      --primary-light: #2196f3;
      --primary-dark: #1565c0;
      --secondary: #f4f6fa;
      --text: #333;
      --text-light: #666;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --border: #e0e7ef;
      --card-bg: #fff;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --radius: 12px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Roboto', 'Noto Sans Myanmar', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
      color: var(--text);
      line-height: 1.6;
      padding: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      padding: 15px 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      position: relative;
      margin-bottom: 25px;
      border-radius: 12px;
    }
    .header-content { flex-grow: 1; }
    .app-title {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 0;
      letter-spacing: 0.5px;
    }
    .capital-info {
      font-size: 1rem;
      margin-top: 5px;
      opacity: 0.9;
    }
    .lang-toggle {
      background: rgba(255,255,255,0.15);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 50px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }
    .lang-toggle:hover { background: rgba(255,255,255,0.25); }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }
    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 25px;
      transition: transform 0.3s;
    }
    .card:hover { transform: translateY(-5px); }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border);
    }
    .card-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--primary);
      margin: 0;
    }
    .card-icon {
      background: var(--primary);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }
    .form-group { margin-bottom: 20px; }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 15px;
    }
    .form-row > * { flex: 1 1 140px; min-width: 0; }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-light);
    }
    input, select, button {
      width: 100%;
      padding: 14px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      outline: none;
      transition: all 0.3s;
      font-family: inherit;
    }
    input:focus, select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2);
    }
    button {
      background: linear-gradient(90deg, var(--primary-light) 0%, var(--primary) 100%);
      color: white;
      border: none;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    button:hover {
      background: var(--primary-dark);
      box-shadow: 0 4px 12px rgba(25, 118, 210, 0.35);
    }
    .btn-success {
      background: linear-gradient(90deg, #4caf50 0%, #2e7d32 100%);
    }
    .btn-danger {
      background: linear-gradient(90deg, #f44336 0%, #d32f2f 100%);
    }
    .btn-warning {
      background: linear-gradient(90deg, #ff9800 0%, #f57c00 100%);
    }
    .table-container {
      overflow-x: auto;
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      margin-top: 20px;
      position: relative;
      padding-bottom: 32px;
    }
    .table-container::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      width: 20px;
      background: linear-gradient(to left, rgba(255,255,255,1) 0%, rgba(255,255,255,0) 100%);
      pointer-events: none;
    }
    .table-container.no-shadow::after {
      display: none !important;
    }
    table {
      width: 100%;
      border-collapse: collapse;
   
    }
    th, td {
      padding: 10px 8px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    th {
      background: #e3f2fd;
      font-weight: 600;
      color: var(--primary);
      position: sticky;
      top: 0;
      white-space: nowrap;
    }
    tr:nth-child(even) { background: #f8fafc; }
    tr:hover { background: #e3f2fd; }
    tfoot th {
      background: #e0e7ef;
      font-weight: 700;
      text-align: right;
    }
    .action-btn {
      padding: 6px 10px;
      font-size: 0.85rem;
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin: 0 2px;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-top: 25px;
    }
    .summary-card {
      background: white;
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      text-align: center;
    }
    .summary-title {
      font-size: 1.1rem;
      color: var(--text-light);
      margin-bottom: 10px;
    }
    .summary-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary);
    }
    .summary-value.income { color: var(--success); }
    .summary-value.expense { color: var(--danger); }
    .summary-value.net { color: var(--primary-dark); }
    .export-section {
      background: white;
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      margin-top: 30px;
    }
    .export-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
    }
    .export-label {
      font-weight: 500;
      color: var(--text-light);
    }
    .card.expense-logs { margin-bottom: 32px; }
    /* Responsive styles */
    @media (max-width: 900px) {
      .app-title { font-size: 1.5rem; }
      .dashboard { grid-template-columns: 1fr; }
      .card { padding: 20px; }
      th, td { padding: 8px 6px; }
      .card-title { font-size: 1.3rem; }
      .lang-toggle { padding: 6px 12px; font-size: 0.85rem; }
    }
    
    @media (max-width: 768px) {
      .container { padding: 15px; }
      .header-container { padding: 12px 15px; }
      .app-title { font-size: 1.3rem; }
      .capital-info { font-size: 0.9rem; }
      .card { padding: 15px; }
      .card-title { font-size: 1.2rem; }
      .form-row { flex-direction: column; gap: 10px; }
      .form-row > * { flex: 1 1 100%; }
      input, select, button { padding: 12px; font-size: 0.95rem; }
      .export-controls { flex-direction: column; align-items: stretch; }

      /* Responsive Table Styles */
      .table-container table thead {
        display: none; /* Hide table headers on mobile */
      }
      .table-container table .data-row {
        display: block;
        width: 100%;
        margin-bottom: 1rem;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1rem;
        background: #fff !important; /* Override striping for card view */
        box-shadow: var(--shadow);
      }
      .table-container table .data-row td {
        display: flex;
        justify-content: space-between;
        text-align: right;
        padding: 0.75rem 0.5rem;
        border-bottom: 1px solid var(--border);
      }
      .table-container table .data-row td:last-child {
        border-bottom: none;
      }
      .table-container table .data-row td::before {
        content: attr(data-label);
        font-weight: 600;
        text-align: left;
        padding-right: 1rem;
        color: var(--primary);
      }
      /* Prevent summary rows from turning into cards */
      .table-container table .summary-row td {
        display: table-cell;
        text-align: left;
      }
      .table-container table .summary-row td:nth-child(2) {
        text-align: right;
        font-weight: 600;
      }

      /* Force table to not behave like a table on mobile */
      .table-container table,
      .table-container table tbody,
      .table-container table tfoot,
      .table-container table tr {
        display: block;
        width: 100%;
      }

      .table-container table tfoot tr {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: #e0e7ef;
        border-radius: 0 0 var(--radius) var(--radius);
        margin-top: 1rem;
      }

      .table-container table tfoot th {
        padding: 0;
        border: none;
        background: transparent;
        color: var(--primary-dark);
        font-weight: 700;
      }
      
      .table-container table tfoot th[colspan] {
        text-align: left;
        color: var(--text);
        font-weight: 600;
      }
      /* End Responsive Table Styles */
    }
    
    @media (max-width: 600px) {
      .header-container { flex-direction: column; align-items: flex-start; gap: 10px; }
      .lang-toggle { position: static; margin-top: 10px; }
      .card { padding: 12px; }
      .card-title { font-size: 1.1rem; }
      th, td { padding: 8px 4px; font-size: 0.9rem; }
      input, select, button { padding: 10px; font-size: 0.9rem; }
      .action-btn { padding: 5px 8px; font-size: 0.8rem; }
      .summary-grid { grid-template-columns: 1fr; }
      .summary-value { font-size: 1.5rem; }
      .table-container { padding-bottom: 16px; }
    }
    
    @media (max-width: 480px) {
      .container { padding: 10px; }
      .header-container { padding: 10px; }
      .app-title { font-size: 1.1rem; }
      .capital-info { font-size: 0.8rem; }
      .card { padding: 10px; }
      .card-title { font-size: 1rem; }
      th, td { padding: 6px 3px; font-size: 0.85rem; }
      input, select, button { padding: 8px; font-size: 0.85rem; }
      .action-btn { padding: 4px 6px; font-size: 0.75rem; }
      .lang-toggle { font-size: 0.8rem; padding: 5px 10px; }
    }
    
    @media (max-width: 360px) {
      .app-title { font-size: 1rem; }
      .card-title { font-size: 0.95rem; }
      th, td { font-size: 0.8rem; }
      input, select, button { font-size: 0.8rem; padding: 7px; }
    }
    .project-tag {
      display: inline-block;
      background: #e0e7ef;
      color: #2563eb;
      font-weight: 600;
      border-radius: 12px;
      padding: 2px 12px;
      font-size: 0.98em;
      margin: 0 0 0 0;
      letter-spacing: 0.2px;
      white-space: nowrap;
    }
    @media (max-width: 768px) {
      .project-tag { font-size: 0.93em; padding: 2px 8px; }
    }
    @media (max-width: 480px) {
      .project-tag { font-size: 0.9em; padding: 2px 6px; }
    }
    .filter-btn-group {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .filter-btn {
      background: #f4f4f4;
      border: 1px solid #bbb;
      border-radius: 6px;
      padding: 6px 14px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s, color 0.2s, border 0.2s;
      color: #333;
    }
    .filter-btn.selected, .filter-btn:active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
    .filter-btn:focus {
      outline: 2px solid var(--primary);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-container">
      <div class="header-content">
        <h1 class="app-title" id="title"></h1>
        <p class="capital-info" id="capital"></p>
      </div>
      <button id="langToggle" class="lang-toggle">
        <i class="fas fa-language"></i>
        <span>မြန်မာ</span>
      </button>
    </div>
    <div class="dashboard">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Member Shares</h2>
          <div class="card-icon">
            <i class="fas fa-users"></i>
          </div>
        </div>
        <div class="table-container no-shadow">
          <table>
            <thead>
              <tr>
                <th id="thMember"></th>
                <th id="thInitial"></th>
                <th id="thRole"></th>
              </tr>
            </thead>
            <tbody id="memberTable"></tbody>
            <tfoot>
              <tr>
                <th id="thTotal"></th>
                <th id="totalInitial"></th>
                <th id="totalExpenses"></th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h2 class="card-title" id="addExpense"></h2>
          <div class="card-icon">
            <i class="fas fa-plus-circle"></i>
          </div>
        </div>
        <div class="form-group">
          <label for="desc" id="descLabel"></label>
          <input type="text" id="desc" placeholder="" />
        </div>
        <div class="form-group">
          <label for="project" id="projectLabel"></label>
          <input type="text" id="project" placeholder="" />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="amount" id="amountLabel"></label>
            <input type="number" id="amount" placeholder="" />
          </div>
          <div class="form-group">
            <label for="member" id="memberLabel"></label>
            <select id="member"></select>
          </div>
        </div>
        <button id="addBtn" class="btn-success"></button>
      </div>
    </div>
    <div class="card expense-logs">
      <div class="card-header">
        <h2 class="card-title" id="logsTitle"></h2>
        <div class="card-icon">
          <i class="fas fa-file-invoice-dollar"></i>
        </div>
      </div>
      <div class="table-container no-shadow">
        <table id="logTable">
          <thead>
            <tr>
              <th id="thDate"></th>
              <th id="thDesc"></th>
              <th id="thProject"></th>
              <th id="thLogMember"></th>
              <th id="thAmount"></th>
              <th id="thActions"></th>
            </tr>
          </thead>
          <tbody id="logBody"></tbody>
          <tfoot>
            <tr>
              <th colspan="4" id="expenseTotalLabelCell"></th>
              <th id="expenseTotalCell"></th>
            </tr>
          </tfoot>
        </table>
        <div class="expense-logs-controls" style="display:flex;align-items:center;gap:1rem;margin:1rem 0 0 0;flex-wrap:wrap;">
          <label for="logRowsPerPage" id="logRowsPerPageLabel" style="font-weight:500;">Rows per page:</label>
          <select id="logRowsPerPage" style="width:auto;min-width:80px;">
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
          <label for="logMemberFilter" id="logMemberFilterLabel" style="font-weight:500;">Member:</label>
          <select id="logMemberFilter" style="width:auto;min-width:120px;"></select>
          <div id="logPagination" style="margin-left:auto;display:flex;align-items:center;gap:0.5rem;"></div>
        </div>
      </div>
    </div>
    <div class="dashboard">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title" id="incomeTitle"></h2>
          <div class="card-icon">
            <i class="fas fa-money-bill-wave"></i>
          </div>
        </div>
        <div class="form-group">
          <label for="incomeDesc" id="incomeDescLabel"></label>
          <input type="text" id="incomeDesc" placeholder="" />
        </div>
        <div class="form-group">
          <label for="incomeAmount" id="incomeAmountLabel"></label>
          <input type="number" id="incomeAmount" placeholder="" />
        </div>
        <button id="addIncomeBtn" class="btn-success"></button>
      </div>
      <div class="card">
        <div class="card-header">
          <h2 class="card-title" id="logsTitle1"></h2>
          <div class="card-icon">
            <i class="fas fa-chart-line"></i>
          </div>
        </div>
        <div class="table-container no-shadow">
          <table id="incomeTable">
            <thead>
              <tr>
                <th id="thIncomeDate"></th>
                <th id="thIncomeDesc"></th>
                <th id="thIncomeAmount"></th>
                <th id="thIncomeActions"></th>
              </tr>
            </thead>
            <tbody id="incomeBody"></tbody>
            <tfoot>
              <tr>
                <th colspan="3" style="text-align:right;" id="thIncomeTotal"></th>
                <th id="totalIncome"></th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
    <div class="export-section">
      <h2 class="card-title" style="margin-bottom: 20px;">Export Data</h2>
      <div class="export-controls">
        <div class="export-label">Select data to export:</div>
        <select id="exportTableSelect">
          <option value="main">Main Table</option>
          <option value="income">Project Income</option>
          <option value="expense">Expense</option>
        </select>
        <button id="exportPDF" class="btn-warning">
          <i class="fas fa-file-pdf"></i>
          Export as PDF
        </button>
        <button id="exportExcel" class="btn-success">
          <i class="fas fa-file-excel"></i>
          Export as Excel
        </button>
      </div>
    </div>
  </div>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getDatabase, ref, set, get, push, onValue, child } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBgpl1Rd_Y5gY4X16jzSEpgFXYDPn4FG7w",
    authDomain: "companytracker-e2f21.firebaseapp.com",
    databaseURL: "https://companytracker-e2f21-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "companytracker-e2f21",
    storageBucket: "companytracker-e2f21.firebasestorage.app",
    messagingSenderId: "83948118379",
    appId: "1:83948118379:web:a70928e648d1fad9bb2c2e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const initialShare = 15000000;
  let members = ['Ko Pyae', 'Ko Oo', 'Ko Sut', 'Ko Soe'];

  const memberTable = document.getElementById("memberTable");
  const logBody = document.getElementById("logBody");
  const incomeBody = document.getElementById('incomeBody');
  const totalIncome = document.getElementById('totalIncome');
  const thIncomeTotal = document.getElementById('thIncomeTotal');

  const thTotal = document.getElementById('thTotal');
  const totalInitial = document.getElementById('totalInitial');
  const totalExpenses = document.getElementById('totalExpenses');
  const totalRemaining = document.getElementById('totalRemaining');
  const currentTotalDiv = document.getElementById('currentTotal');

  const thOtherIncomeTotal = document.getElementById('thOtherIncomeTotal');
  const totalOtherIncome = document.getElementById('totalOtherIncome');

  const LANGS = {
    en: {
      title: "Company Expense Tracker",
      capital: "Starting Capital: <strong>60,000,000 MMK</strong> — Each Member: <strong>15,000,000 MMK</strong>",
      thMember: "Member",
      thInitial: "Initial Share",
      thExpenses: "Expenses",
      thRemaining: "Remaining",
      addExpense: "Add Expense",
      desc: "Description",
      project: "Project",
      amount: "Amount",
      member: "Member",
      add: "Add",
      update: "Update",
      logsTitle: "Expense Logs",
      logsTitle1: "Project Income Logs",
      thDate: "Date",
      thDesc: "Description",
      thLogMember: "Member",
      thAmount: "Amount",
      thActions: "Actions",
      edit: "Edit",
      del: "Delete",
      alert: "Please enter a valid description and amount.",
      confirmDel: "Are you sure you want to delete this log?",
      incomeTitle: "Project Income",
      thIncomeDate: "Date",
      thIncomeDesc: "Description",
      thIncomeAmount: "Amount",
      thIncomeActions: "Total",
      projectIncomeRow: "Project Income",
      thRole: "Role",
      updateRow: "Update",
      incomeRow: 'Project Income',
      expenseRow: 'Expenses',
      expenseTotal: 'Total',
      exportSection: "Export Data",
      exportLabel: "Select data to export:",
      exportMain: "Main Table",
      exportIncome: "Project Income",
      exportExpense: "Expense Logs",
      exportPDF: "Export as PDF",
      exportExcel: "Export as Excel",
      rowsPerPage: "Rows per page:",
      memberFilter: "Member:",
      allMembers: "All Members",
      projectFilter: "Project:",
      allProjects: "All Projects",
    },
    my: {
      title: "ကုမ္ပဏီအသုံးစရိတ် စာရင်း ",
      capital: "အစပြုမြန်မာငွေ: <strong>၆၀,၀၀၀,၀၀၀ MMK</strong> — တစ်ဦးလျှင်: <strong>၁၅,၀၀၀,၀၀၀ MMK</strong>",
      thMember: "အမည်",
      thInitial: "အစပြုငွေ",
      thExpenses: "အသုံးစရိတ်",
      thRemaining: "ကျန်ငွေ",
      addExpense: "အသုံးစရိတ်ထည့်ရန်",
      desc: "အသေးစိတ်ဖော်ပြချက်",
      project: "ပရောဂျက်",
      amount: "ငွေပမာဏ",
      member: "အမည်",
      add: "ထည့်မည်",
      update: "ပြင်မည်",
      logsTitle: "အသုံးစရိတ် မှတ်တမ်းများ",
      logsTitle1: "ပရောဂျက်ဝင်ငွေ မှတ်တမ်းများ",
      thDate: "နေ့စွဲ",
      thDesc: "ဖော်ပြချက်",
      thLogMember: "အမည်",
      thAmount: "ငွေပမာဏ",
      thActions: "လုပ်ဆောင်ချက်များ",
      edit: "ပြင်ရန်",
      del: "ဖျက်ရန်",
      alert: "ကျေးဇူးပြု၍ မှန်ကန်သော ဖော်ပြချက်နှင့် ငွေပမာဏ ထည့်ပါ။",
      confirmDel: "ဤမှတ်တမ်းကို ဖျက်ရန် သေချာပါသလား?",
      incomeTitle: "ပရောဂျက်ဝင်ငွေ",
      thIncomeDate: "နေ့စွဲ",
      thIncomeDesc: "ဖော်ပြချက်",
      thIncomeAmount: "ငွေပမာဏ",
      thIncomeActions: "စုစုပေါင်း",
      projectIncomeRow: "ပရောဂျက်ဝင်ငွေ",
      thRole: "တာဝန်",
      updateRow: "အပ်ဒိတ်",
      incomeRow: 'ပရောဂျက်ဝင်ငွေ',
      expenseRow: 'အသုံးစရိတ်',
      expenseTotal: 'စုစုပေါင်း',
      exportSection: "ဒေတာထုတ်ယူရန်",
      exportLabel: "ထုတ်ယူမည့်အချက်အလက်ရွေးပါ:",
      exportMain: "အဓိကဇယား",
      exportIncome: "ပရောဂျက်ဝင်ငွေ",
      exportExpense: "အသုံးစရိတ်မှတ်တမ်း",
      exportPDF: "PDF အဖြစ်ထုတ်မည်",
      exportExcel: "Excel အဖြစ်ထုတ်မည်",
      rowsPerPage: "တစ်စာမျက်နှာလျှင် အတန်းအရေအတွက်:",
      memberFilter: "အမည်:",
      allMembers: "အားလုံး",
      projectFilter: "ပရောဂျက်:",
      allProjects: "အားလုံး",
    }
  };

  let lang = localStorage.getItem('lang') || 'en';
  function setLangTexts() {
    const t = LANGS[lang];
    document.getElementById('title').textContent = t.title;
    document.getElementById('capital').innerHTML = t.capital;
    document.getElementById('thMember').textContent = t.thMember;
    document.getElementById('thInitial').textContent = t.thInitial;
    document.getElementById('thRole').textContent = t.thRole;
    document.getElementById('addExpense').textContent = t.addExpense;
    document.getElementById('desc').placeholder = t.desc;
    document.getElementById('amount').placeholder = t.amount;
    document.getElementById('addBtn').textContent = window.editingLogId ? t.update : t.add;
    document.getElementById('logsTitle').textContent = t.logsTitle;
    document.getElementById('logsTitle1').textContent = t.logsTitle1;
    document.getElementById('thDate').textContent = t.thDate;
    document.getElementById('thDesc').textContent = t.thDesc;
    document.getElementById('thLogMember').textContent = t.thLogMember;
    document.getElementById('thAmount').textContent = t.thAmount;
    // Member select
    const memberSel = document.getElementById('member');
    memberSel.innerHTML = '';
    members.forEach((name, i) => {
      memberSel.innerHTML += `<option value="${i}">${name}</option>`;
    });
    document.getElementById('incomeTitle').textContent = t.incomeTitle;
    document.getElementById('incomeDesc').placeholder = t.desc;
    document.getElementById('incomeAmount').placeholder = t.amount;
    document.getElementById('addIncomeBtn').textContent = window.editingIncomeId ? t.update : t.add;
    document.getElementById('thIncomeDate').textContent = t.thIncomeDate;
    document.getElementById('thIncomeDesc').textContent = t.thIncomeDesc;
    document.getElementById('thIncomeAmount').textContent = t.thIncomeAmount;
    thIncomeTotal.textContent = t.thIncomeActions;
    window.projectIncomeRowLabel = t.projectIncomeRow;
    window.updateRowLabel = t.updateRow;
    window.incomeRowLabel = t.incomeRow;
    window.expenseRowLabel = t.expenseRow;
    window.expenseTotalLabel = t.expenseTotal;
    // Export section localization
    document.querySelector('.export-section .card-title').textContent = t.exportSection;
    document.querySelector('.export-label').textContent = t.exportLabel;
    const exportSelect = document.getElementById('exportTableSelect');
    exportSelect.options[0].text = t.exportMain;
    exportSelect.options[1].text = t.exportIncome;
    exportSelect.options[2].text = t.exportExpense;
    document.getElementById('exportPDF').innerHTML = `<i class="fas fa-file-pdf"></i> ${t.exportPDF}`;
    document.getElementById('exportExcel').innerHTML = `<i class="fas fa-file-excel"></i> ${t.exportExcel}`;
    document.getElementById('logRowsPerPageLabel').textContent = t && t.rowsPerPage ? t.rowsPerPage : 'Rows per page:';
    const logMemberFilter = document.getElementById('logMemberFilter');
    logMemberFilter.innerHTML = `<option value="all">${t && t.allMembers ? t.allMembers : 'All Members'}</option>`;
    members.forEach((name, i) => {
      logMemberFilter.innerHTML += `<option value="${i}">${name}</option>`;
    });
    logMemberFilter.value = logMemberFilterValue;
    logMemberFilter.onchange = function() {
      logMemberFilterValue = this.value;
      logCurrentPage = 1;
      renderLogs(window.currentLogs || {});
    };
    // Remove project filter and project select logic

    document.getElementById('project').placeholder = t.project;
  
    // Set projects array to use the translated project label
    projects = [t.thProject];
  }

  document.getElementById('langToggle').onclick = function() {
    lang = lang === 'en' ? 'my' : 'en';
    localStorage.setItem('lang', lang);
    this.querySelector('span').textContent = lang === 'en' ? 'မြန်မာ' : 'English';
    setLangTexts();
    renderLogs(window.currentLogs || {});
  };

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('langToggle').querySelector('span').textContent = lang === 'en' ? 'မြန်မာ' : 'English';
    setLangTexts();
  });

  function renderTable(data) {
    memberTable.innerHTML = "";
    let sumInitial = 0;
    // Calculate total project income
    let totalIncomeValue = 0;
    for (const id in window.currentIncomes) {
      totalIncomeValue += window.currentIncomes[id].amount || 0;
    }
    // Calculate total expenses from all logs
    let totalExpensesValue = 0;
    for (const id in window.currentLogs) {
      totalExpensesValue += window.currentLogs[id].amount || 0;
    }
    const roles = ['Member', 'Member', 'Member', 'Member']; // You can customize roles here
    const t = LANGS[lang];
    // Add data rows for members
    members.forEach((name, i) => {
      sumInitial += initialShare;
      memberTable.innerHTML += `
        <tr class="data-row">
          <td data-label="${t.thMember}">${name}</td>
          <td data-label="${t.thInitial}">${initialShare.toLocaleString()}</td>
          <td data-label="${t.thRole}">${roles[i]}</td>
        </tr>
      `;
    });

    const netChange = totalIncomeValue - totalExpensesValue;
    memberTable.innerHTML += `
      <tr style="font-weight:bold; background:#f4f4f4; color:#333;" class="summary-row">
        <td>${t.updateRow}</td>
        <td>${netChange >= 0 ? '+' : ''}${netChange.toLocaleString()}</td>
        <td></td>
      </tr>
    `;
    memberTable.innerHTML += `
      <tr style="font-weight:bold; background:#e6ffe6; color:#333;" class="summary-row">
        <td>${t.incomeRow}</td>
        <td>+${totalIncomeValue.toLocaleString()}</td>
        <td></td>
      </tr>
    `;
    memberTable.innerHTML += `
      <tr style="font-weight:bold; background:#ffe6e6; color:#333;" class="summary-row">
        <td>${t.expenseRow}</td>
        <td>-${totalExpensesValue.toLocaleString()}</td>
        <td></td>
      </tr>
    `;
    const remaining = sumInitial + totalIncomeValue - totalExpensesValue;
    memberTable.innerHTML += `
      <tr style="font-weight:bold; background:#e0e7ef; color:#222;" class="summary-row">
        <td>${t.thRemaining}</td>
        <td>${remaining.toLocaleString()}</td>
        <td></td>
      </tr>
    `;
  }

  // --- PAGINATION STATE ---
  let logRowsPerPage = 100;
  let logCurrentPage = 1;
  let logTotalPages = 1;
  let logIdsSorted = [];
  let logMemberFilterValue = 'all';
  let logProjectFilterValue = 'all';
  let projectSortAsc = true;

  // --- PAGINATION UI HANDLERS ---
  const logRowsPerPageSelect = document.getElementById('logRowsPerPage');
  logRowsPerPageSelect.value = logRowsPerPage;
  logRowsPerPageSelect.onchange = function() {
    logRowsPerPage = parseInt(this.value);
    logCurrentPage = 1;
    localStorage.setItem('logRowsPerPage', logRowsPerPage);
    renderLogs(window.currentLogs || {});
  };

  // --- MODIFIED renderLogs WITH PAGINATION ---
  function renderLogs(data) {
    logBody.innerHTML = "";
    let total = 0;
    const t = LANGS[lang];
    // Filter logs by member and project if needed
    let filteredIds = Object.keys(data);
    if (logMemberFilterValue !== 'all') {
      filteredIds = filteredIds.filter(id => String(data[id].member) === logMemberFilterValue);
    }
    if (logProjectFilterValue !== 'all') {
      filteredIds = filteredIds.filter(id => (data[id].project || '') === logProjectFilterValue);
    }
    // Sort logs by date descending (most recent first)
    logIdsSorted = filteredIds.sort((a, b) => {
      const da = data[a].date || '';
      const db = data[b].date || '';
      return db.localeCompare(da);
    });
    logTotalPages = Math.max(1, Math.ceil(logIdsSorted.length / logRowsPerPage));
    if (logCurrentPage > logTotalPages) logCurrentPage = logTotalPages;
    const startIdx = (logCurrentPage - 1) * logRowsPerPage;
    const endIdx = startIdx + logRowsPerPage;
    const pageIds = logIdsSorted.slice(startIdx, endIdx);
    for (const id of pageIds) {
      const entry = data[id];
      const date = entry.date ? new Date(entry.date).toLocaleString() : '-';
      total += entry.amount;
      logBody.innerHTML += `
        <tr class="data-row">
          <td data-label="${t.thDate}">${date}</td>
          <td data-label="${t.thDesc}">${entry.desc}</td>
          <td data-label="${t.thProject}"><span class="project-tag">
            ${entry.project ? entry.project : ''}
          </span></td>
          <td data-label="${t.thLogMember}">${members[entry.member]}</td>
          <td data-label="${t.thAmount}">${entry.amount.toLocaleString()} MMK</td>
          <td data-label="${t.thActions}">
            <button onclick="editLog('${id}')" class="action-btn btn-warning">${t.edit}</button>
            <button onclick="deleteLog('${id}')" class="action-btn btn-danger">${t.del}</button>
          </td>
        </tr>
      `;
    }
    document.getElementById('expenseTotalLabelCell').textContent = t.expenseTotal;
    document.getElementById('expenseTotalCell').textContent = total.toLocaleString() + ' MMK';
    updateLogPaginationUI();
  }

  window.editLog = function(id) {
    const entry = window.currentLogs[id];
    document.getElementById("desc").value = entry.desc;
    document.getElementById("project").value = entry.project || '';
    document.getElementById("amount").value = entry.amount;
    document.getElementById("member").value = entry.member;
    window.editingLogId = id;
    setLangTexts();
  };

  window.deleteLog = async function(id) {
    if (confirm(LANGS[lang].confirmDel)) {
      await set(ref(db, `logs/${id}`), null);
    }
  };

  let currentLogs = {};
  window.currentLogs = currentLogs;
  window.editingLogId = null;

  // Add or update log
  const addBtn = document.getElementById("addBtn");
  addBtn.addEventListener("click", async () => {
    const desc = document.getElementById("desc").value;
    let project = document.getElementById("project").value;
    if (project === '__new__') {
      project = document.getElementById("projectNew").value.trim();
    }
    const amount = parseInt(document.getElementById("amount").value);
    const member = parseInt(document.getElementById("member").value);
    const now = new Date().toISOString();

    if (!desc || isNaN(amount) || amount <= 0) {
      alert(LANGS[lang].alert);
      return;
    }

    if (window.editingLogId) {
      // Update existing log
      await set(ref(db, `logs/${window.editingLogId}`), {
        desc,
        project,
        amount,
        member,
        date: now
      });
      window.editingLogId = null;
      addBtn.textContent = "Add";
    } else {
      // Add new log
      await push(ref(db, "logs"), {
        desc,
        project,
        amount,
        member,
        date: now
      });
    }

    document.getElementById("desc").value = '';
    document.getElementById("project").value = '';
    document.getElementById("amount").value = '';
  });

  // Real-time sync
  onValue(ref(db, "expenses"), (snapshot) => {
    const data = snapshot.val() || {};
    window.lastExpensesSnapshot = data;
    renderTable(data);
  });

  onValue(ref(db, "logs"), (snapshot) => {
    const data = snapshot.val() || {};
    window.currentLogs = data;
    renderLogs(data);
    setLangTexts();
  });

  // Export PDF
  window.exportLogsPDF = function() {
    const currentLang = localStorage.getItem('lang') || 'en';
    const t = LANGS[currentLang];
    const selected = document.getElementById('exportTableSelect').value;
    const doc = new window.jspdf.jsPDF();
    let head = [], body = [], filename = '';
    const locale = currentLang === 'my' ? 'my-MM' : 'en-US';
    if (selected === 'main') {
      head = [[t.thMember, t.thInitial, t.thRole]];
      for (let i = 0; i < members.length; i++) {
        body.push([
          members[i],
          initialShare.toLocaleString() + ' MMK',
          t.thRole
        ]);
      }
      let totalIncomeValue = 0;
      for (const id in window.currentIncomes) {
        totalIncomeValue += window.currentIncomes[id].amount || 0;
      }
      let totalExpensesValue = 0;
      for (const id in window.currentLogs) {
        totalExpensesValue += window.currentLogs[id].amount || 0;
      }
      const netChange = totalIncomeValue - totalExpensesValue;
      body.push([t.updateRow, (netChange >= 0 ? '+' : '') + netChange.toLocaleString() + ' MMK', '']);
      body.push([t.incomeRow, '+' + totalIncomeValue.toLocaleString() + ' MMK', '']);
      body.push([t.expenseRow, '-' + totalExpensesValue.toLocaleString() + ' MMK', '']);
      const sumInitial = initialShare * members.length;
      const remaining = sumInitial + totalIncomeValue - totalExpensesValue;
      body.push([t.thRemaining, remaining.toLocaleString() + ' MMK', '']);
      filename = 'main_table.pdf';
    } else if (selected === 'income') {
      head = [[t.thDate, t.thDesc, t.thAmount]];
      for (const id in window.currentIncomes) {
        const entry = window.currentIncomes[id];
        const date = entry.date ? new Date(entry.date).toLocaleString(locale) : '-';
        body.push([
          date,
          entry.desc,
          entry.amount.toLocaleString() + ' MMK'
        ]);
      }
      filename = 'project_income.pdf';
    } else if (selected === 'expense') {
      head = [[t.thDate, t.thDesc, t.project, t.thLogMember, t.thAmount]];
      for (const id in window.currentLogs) {
        const entry = window.currentLogs[id];
        const date = entry.date ? new Date(entry.date).toLocaleString(locale) : '-';
        body.push([
          date,
          entry.desc,
          entry.project || '',
          members[entry.member],
          entry.amount.toLocaleString() + ' MMK'
        ]);
      }
      filename = 'expense.pdf';
    }
    doc.autoTable({ head, body });
    doc.save(filename);
  };

  // Export Excel
  window.exportLogsExcel = function() {
    const t = LANGS[lang];
    const selected = document.getElementById('exportTableSelect').value;
    let ws_data = [], filename = '';
    const locale = getLocale();
    if (selected === 'main') {
      ws_data = [[t.thMember, t.thInitial, t.thRole]];
      for (let i = 0; i < members.length; i++) {
        ws_data.push([
          members[i],
          initialShare.toLocaleString() + ' MMK',
          t.thRole
        ]);
      }
      let totalIncomeValue = 0;
      for (const id in window.currentIncomes) {
        totalIncomeValue += window.currentIncomes[id].amount || 0;
      }
      let totalExpensesValue = 0;
      for (const id in window.currentLogs) {
        totalExpensesValue += window.currentLogs[id].amount || 0;
      }
      const netChange = totalIncomeValue - totalExpensesValue;
      ws_data.push([t.updateRow, (netChange >= 0 ? '+' : '') + netChange.toLocaleString() + ' MMK', '']);
      ws_data.push([t.incomeRow, '+' + totalIncomeValue.toLocaleString() + ' MMK', '']);
      ws_data.push([t.expenseRow, '-' + totalExpensesValue.toLocaleString() + ' MMK', '']);
      const sumInitial = initialShare * members.length;
      const remaining = sumInitial + totalIncomeValue - totalExpensesValue;
      ws_data.push([t.thRemaining, remaining.toLocaleString() + ' MMK', '']);
      filename = 'main_table.xlsx';
    } else if (selected === 'income') {
      ws_data = [[t.thDate, t.thDesc, t.thAmount]];
      for (const id in window.currentIncomes) {
        const entry = window.currentIncomes[id];
        const date = entry.date ? new Date(entry.date).toLocaleString(locale) : '-';
        ws_data.push([
          date,
          entry.desc,
          entry.amount.toLocaleString() + ' MMK'
        ]);
      }
      filename = 'project_income.xlsx';
    } else if (selected === 'expense') {
      ws_data = [[t.thDate, t.thDesc, t.project, t.thLogMember, t.thAmount]];
      for (const id in window.currentLogs) {
        const entry = window.currentLogs[id];
        const date = entry.date ? new Date(entry.date).toLocaleString(locale) : '-';
        ws_data.push([
          date,
          entry.desc,
          entry.project || '',
          members[entry.member],
          entry.amount.toLocaleString() + ' MMK'
        ]);
      }
      filename = 'expense.xlsx';
    }
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
    XLSX.writeFile(wb, filename);
  };

  document.getElementById('exportPDF').onclick = window.exportLogsPDF;
  document.getElementById('exportExcel').onclick = window.exportLogsExcel;

  function renderIncomes(data) {
    incomeBody.innerHTML = "";
    let sumIncome = 0;
    const t = LANGS[lang];
    for (const id in data) {
      const entry = data[id];
      const date = entry.date ? new Date(entry.date).toLocaleString() : '-';
      sumIncome += entry.amount;
      incomeBody.innerHTML += `
        <tr class="data-row">
          <td data-label="${t.thIncomeDate}">${date}</td>
          <td data-label="${t.thIncomeDesc}">${entry.desc}</td>
          <td data-label="${t.thIncomeAmount}">${entry.amount.toLocaleString()} MMK</td>
          <td data-label="${t.thActions}">
            <button onclick="editIncome('${id}')" class="action-btn btn-warning">${t.edit}</button>
            <button onclick="deleteIncome('${id}')" class="action-btn btn-danger">${t.del}</button>
          </td>
        </tr>
      `;
    }
    document.getElementById('thIncomeTotal').textContent = t.expenseTotal;
    document.getElementById('totalIncome').textContent = sumIncome.toLocaleString() + ' MMK';
  }

  window.editIncome = function(id) {
    const entry = window.currentIncomes[id];
    document.getElementById("incomeDesc").value = entry.desc;
    document.getElementById("incomeAmount").value = entry.amount;
    window.editingIncomeId = id;
    setLangTexts();
  };

  window.deleteIncome = async function(id) {
    if (confirm(LANGS[lang].confirmDel)) {
      await set(ref(db, `incomes/${id}`), null);
    }
  };

  let currentIncomes = {};
  window.currentIncomes = currentIncomes;
  window.editingIncomeId = null;

  document.getElementById("addIncomeBtn").addEventListener("click", async () => {
    const desc = document.getElementById("incomeDesc").value;
    const amount = parseInt(document.getElementById("incomeAmount").value);
    const now = new Date().toISOString();
    if (!desc || isNaN(amount) || amount <= 0) {
      alert(LANGS[lang].alert);
      return;
    }
    if (window.editingIncomeId) {
      await set(ref(db, `incomes/${window.editingIncomeId}`), {
        desc,
        amount,
        date: now
      });
      window.editingIncomeId = null;
      document.getElementById("addIncomeBtn").textContent = LANGS[lang].add;
    } else {
      await push(ref(db, "incomes"), {
        desc,
        amount,
        date: now
      });
    }
    document.getElementById("incomeDesc").value = '';
    document.getElementById("incomeAmount").value = '';
  });

  onValue(ref(db, "incomes"), (snapshot) => {
    const data = snapshot.val() || {};
    window.currentIncomes = data;
    renderIncomes(data);
    // Update share table as well
    const expensesSnapshot = window.lastExpensesSnapshot || {};
    renderTable(expensesSnapshot);
  });

  document.getElementById('thProject').onclick = function() {
    projectSortAsc = !projectSortAsc;
    // Sort logs by project name
    const data = window.currentLogs || {};
    let filteredIds = Object.keys(data);
    if (logMemberFilterValue !== 'all') {
      filteredIds = filteredIds.filter(id => String(data[id].member) === logMemberFilterValue);
    }
    if (logProjectFilterValue !== 'all') {
      filteredIds = filteredIds.filter(id => (data[id].project || '') === logProjectFilterValue);
    }
    filteredIds.sort((a, b) => {
      const pa = (data[a].project || '').toLowerCase();
      const pb = (data[b].project || '').toLowerCase();
      if (pa < pb) return projectSortAsc ? -1 : 1;
      if (pa > pb) return projectSortAsc ? 1 : -1;
      return 0;
    });
    // Re-render only the visible page
    logBody.innerHTML = "";
    const t = LANGS[lang];
    const startIdx = (logCurrentPage - 1) * logRowsPerPage;
    const endIdx = startIdx + logRowsPerPage;
    const pageIds = filteredIds.slice(startIdx, endIdx);
    let total = 0;
    for (const id of pageIds) {
      const entry = data[id];
      const date = entry.date ? new Date(entry.date).toLocaleString() : '-';
      total += entry.amount;
      logBody.innerHTML += `
        <tr class="data-row">
          <td data-label="${t.thDate}">${date}</td>
          <td data-label="${t.thDesc}">${entry.desc}</td>
          <td data-label="${t.thProject}"><span class="project-tag">
            ${entry.project ? entry.project : ''}
          </span></td>
          <td data-label="${t.thLogMember}">${members[entry.member]}</td>
          <td data-label="${t.thAmount}">${entry.amount.toLocaleString()} MMK</td>
          <td data-label="${t.thActions}">
            <button onclick="editLog('${id}')" class="action-btn btn-warning">${t.edit}</button>
            <button onclick="deleteLog('${id}')" class="action-btn btn-danger">${t.del}</button>
          </td>
        </tr>
      `;
    }
    document.getElementById('expenseTotalLabelCell').textContent = t.expenseTotal;
    document.getElementById('expenseTotalCell').textContent = total.toLocaleString() + ' MMK';
    updateLogPaginationUI();
  };
  </script>
</body>
</html>
